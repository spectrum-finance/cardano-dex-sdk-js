import test from "ava"
import {RustModule} from "../../utils/rustLoader.js"
import {mkOrdersParser} from "./ordersParser.js"
import {ScriptCredsV1} from "../scripts.js"
import {QuickblueTx} from "../../quickblue/models.js"
import {JSONBI} from "../../utils/json.js"

test.before(async () => {
  await RustModule.load({env: "nodejs"})
})

const sampleResponse = `
[
  {"blockHash":"5f1fecd6161c3f652d409ce67f538c32508cf34a6188ab92ff64c7af0e39d5ab","blockIndex":12,"globalIndex":4405406,"hash":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e","inputs":[{"out":{"ref":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9:2","blockHash":"5f1fecd6161c3f652d409ce67f538c32508cf34a6188ab92ff64c7af0e39d5ab","txHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9","index":2,"globalIndex":10615835,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":306403837,"jsQuantity":"306403837"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e"},"redeemer":null},{"out":{"ref":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9:1","blockHash":"5f1fecd6161c3f652d409ce67f538c32508cf34a6188ab92ff64c7af0e39d5ab","txHash":"65c30f004a1988b65d3e86eff6e445e7bc7eea797a7b73ea3ac0f02207b7add9","index":1,"globalIndex":10615834,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":3206826,"jsQuantity":"3206826"},{"policyId":"c3b39f2855f1c15c1d773f5cc51fc4c9987af269435fcbc6fe452cc5","name":"cNETAt_ADAt_lp","quantity":8219055,"jsQuantity":"8219055"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"cNETAt","quantity":984197286,"jsQuantity":"984197286"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"WMTt","quantity":105090936730,"jsQuantity":"105090936730"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"VYFIt","quantity":461666546,"jsQuantity":"461666546"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"MELDt","quantity":1865310954,"jsQuantity":"1865310954"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"HOSKYt","quantity":2120721697,"jsQuantity":"2120721697"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GEROt","quantity":983244432,"jsQuantity":"983244432"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GENSt","quantity":3990615731,"jsQuantity":"3990615731"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"C3t","quantity":3990000000,"jsQuantity":"3990000000"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"AADAt","quantity":1373840518,"jsQuantity":"1373840518"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenNFT","quantity":1000000,"jsQuantity":"1000000"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenLP","quantity":1000010,"jsQuantity":"1000010"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenB","quantity":921822013,"jsQuantity":"921822013"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenA","quantity":651648821,"jsQuantity":"651648821"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"789ergoTestTokenLP789","quantity":19354820,"jsQuantity":"19354820"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"321ergoTestTokenLP321","quantity":84052980,"jsQuantity":"84052980"},{"policyId":"2493a4a9842d3d42f0aafd6a63afd7b13477f2524816e353f3b98378","name":"ergoTestTokenA","quantity":10,"jsQuantity":"10"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e"},"redeemer":null}],"outputs":[{"ref":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e:2","blockHash":"5f1fecd6161c3f652d409ce67f538c32508cf34a6188ab92ff64c7af0e39d5ab","txHash":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e","index":2,"globalIndex":10865624,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":301405918,"jsQuantity":"301405918"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":null},{"ref":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e:1","blockHash":"5f1fecd6161c3f652d409ce67f538c32508cf34a6188ab92ff64c7af0e39d5ab","txHash":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e","index":1,"globalIndex":10865623,"addr":"addr_test1qrmzenza7gnsk3zsu40rnwmqes93nmmynzkzsr8g2j3a4fzvqenn455uh4r4e740drhycwlssxgnam4tjwf7uqfta4xqjhwx2c","rawAddr":"00f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa44c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c","paymentCred":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4","value":[{"policyId":"","name":"","quantity":3206826,"jsQuantity":"3206826"},{"policyId":"c3b39f2855f1c15c1d773f5cc51fc4c9987af269435fcbc6fe452cc5","name":"cNETAt_ADAt_lp","quantity":8219055,"jsQuantity":"8219055"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"cNETAt","quantity":984197286,"jsQuantity":"984197286"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"WMTt","quantity":105090936730,"jsQuantity":"105090936730"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"VYFIt","quantity":461666546,"jsQuantity":"461666546"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"MELDt","quantity":1865310954,"jsQuantity":"1865310954"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"HOSKYt","quantity":2120721697,"jsQuantity":"2120721697"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GEROt","quantity":983244432,"jsQuantity":"983244432"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GENSt","quantity":3989615731,"jsQuantity":"3989615731"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"C3t","quantity":3990000000,"jsQuantity":"3990000000"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"AADAt","quantity":1373840518,"jsQuantity":"1373840518"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenNFT","quantity":1000000,"jsQuantity":"1000000"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenLP","quantity":1000010,"jsQuantity":"1000010"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenB","quantity":921822013,"jsQuantity":"921822013"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"ergoTestTokenA","quantity":651648821,"jsQuantity":"651648821"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"789ergoTestTokenLP789","quantity":19354820,"jsQuantity":"19354820"},{"policyId":"805fe1efcdea11f1e959eff4f422f118aa76dca2d0d797d184e487da","name":"321ergoTestTokenLP321","quantity":84052980,"jsQuantity":"84052980"},{"policyId":"2493a4a9842d3d42f0aafd6a63afd7b13477f2524816e353f3b98378","name":"ergoTestTokenA","quantity":10,"jsQuantity":"10"}],"dataHash":null,"data":null,"dataBin":null,"spentByTxHash":null},{"ref":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e:0","blockHash":"5f1fecd6161c3f652d409ce67f538c32508cf34a6188ab92ff64c7af0e39d5ab","txHash":"826dd15320a2b170a1c6f194a93f1ea33398528f4e5291ab06d54b808f4ab90e","index":0,"globalIndex":10865622,"addr":"addr_test1wzs0df8en2dage286us3xgv2mwf0yekj9wddud04gwe9p7sgd4ug7","rawAddr":"70a0f6a4f99a9bd46547d72113218adb92f266d22b9ade35f543b250fa","paymentCred":"a0f6a4f99a9bd46547d72113218adb92f266d22b9ade35f543b250fa","value":[{"policyId":"","name":"","quantity":4805578,"jsQuantity":"4805578"},{"policyId":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac","name":"GENSt","quantity":1000000,"jsQuantity":"1000000"}],"dataHash":"79a2f2c64820f4d20f00c481c1991bf1fde33962c345e6567cef7a492f077ce3","data":{"fields":[{"fields":[{"bytes":"79d370f5c37dcc223c6b7bbb5da1c9839fa0413dff44ba35a6cfa9b9"},{"bytes":"47454e53745f414441745f6e6674"}],"constructor":0},{"fields":[{"bytes":"b8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac"},{"bytes":"47454e5374"}],"constructor":0},{"fields":[{"bytes":""},{"bytes":""}],"constructor":0},{"fields":[{"bytes":"514bea316c280a382aa855b20fac6242d891477ddd813c0bdd37b925"},{"bytes":"47454e53745f414441745f6c70"}],"constructor":0},{"int":2000000},{"bytes":"f62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4"},{"fields":[{"bytes":"4c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4c"}],"constructor":0},{"int":1379280}],"constructor":0},"dataBin":"d8799fd8799f581c79d370f5c37dcc223c6b7bbb5da1c9839fa0413dff44ba35a6cfa9b94e47454e53745f414441745f6e6674ffd8799f581cb8aa6f60b48ad4cb0f623edc96eb4dffb652b3a2384287b22c8814ac4547454e5374ffd8799f4040ffd8799f581c514bea316c280a382aa855b20fac6242d891477ddd813c0bdd37b9254d47454e53745f414441745f6c70ff1a001e8480581cf62ccc5df2270b4450e55e39bb60cc0b19ef6498ac280ce854a3daa4d8799f581c4c06673ad29cbd475cfaaf68ee4c3bf081913eeeab9393ee012bed4cff1a00150bd0ff","spentByTxHash":"cec67ef2656db20f6f8d88f807d60da151acc2fe84f2939b20e4bba8eb2b574a"}],"invalidBefore":null,"invalidHereafter":null,"metadata":null,"size":835}
]
`

const txs: QuickblueTx[] = JSONBI.parse(sampleResponse)
test("parse order", async t => {
  const parser = mkOrdersParser(ScriptCredsV1, RustModule.CardanoWasm)
  const orders = txs.flatMap(tx => tx.outputs.map(out => parser.parseOrder(out))).filter(Boolean)
  t.assert(orders.length !== 0, "Orders are not parsed")
  t.log(orders)
})
